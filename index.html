<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.8.2/css/ol.css" type="text/css">
    <style>
      .map {
        height: 1200px;
        width: 100%;
      }
      body {
          font-family: sans-serif;
      }
    </style>
    <script src="http://openlayers.org/en/v3.8.2/build/ol.js" type="text/javascript"></script>
    <title>VisualTraclus Porto</title>
  </head>
  <body>
    <h2>VisualTraclus: Porto Taxi data</h2>
    <div id="map" class="map"></div>


    <input type="file" id="file-input" />
    <div id="information-text"></div>

    <script type="text/javascript">

      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.MapQuest({layer: 'osm'})
            , opacity: 0.6
          })
        ],
        view: new ol.View({
            center: ol.proj.transform([-8.629749, 41.159364], 'EPSG:4326', 'EPSG:3857'),
            zoom: 13
        })
      });

      var features = [];

      function addCluster(coordinates) {
          console.log(coordinates)
          coordinates.splice(0,1);
          console.log(coordinates);
          var points = [];
          for (var i=0;i<coordinates.length/2;i++){
              var x = parseFloat(coordinates[2*i]);
              var y = parseFloat(coordinates[2*i+1]);
            console.log(x);
            console.log(y)
              points[i] = ol.proj.transform([y,x], 'EPSG:4326',   'EPSG:3857');
          }
          features.push(new ol.Feature({
              geometry: new ol.geom.LineString(points, 'XY'),
              name: 'Line'
          }));

      }


      function parseClusters(clusterFile) {
          var lines = clusterFile.split("\n");
          if(lines[lines.length-1] == "")
            lines.splice(lines.length-1, 1);
          for(var i = 0; i<lines.length; i++) {
              addCluster(lines[i].split(" "));
          }

          var layerLines = new ol.layer.Vector({
              source: new ol.source.Vector({
                  features: features,
              }),
              style: new ol.style.Style({
                  stroke: new ol.style.Stroke({
                      color: '#000000',
                      width: 4
                  })
              })
          });

          map.addLayer(layerLines);
debugger;
          var element = document.getElementById('information-text');
          element.innerHTML = lines.length + " clusters in file.<br>Filename: " + clusterFile.name;

          document.getElementById('file-input').style.display = "none";

      }
      var filename = "";
      function readSingleFile(e) {
        var file = e.target.files[0];

        if (!file) {
          return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
          var contents = e.target.result;
          parseClusters(contents);
        };
        reader.readAsText(file);
      }

      document.getElementById('file-input')
        .addEventListener('change', readSingleFile, false);

    </script>
  </body>
</html>
